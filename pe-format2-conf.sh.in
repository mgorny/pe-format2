#!/bin/sh
# Regenerate the configuration for pe-exec, using the variables exported
# in the environment (hopefully by the init.d script).

if [ -n "${RC_SVCNAME}" ]; then
	ewarn=ewarn
	eerror=eerror
else
	ewarn=echo
	eerror=echo
fi

firstworking() {
	while [ ${#} -gt 1 ]; do
		if "${1}" --version >/dev/null 2>&1; then
			echo "${1}"
			return
		fi
		shift
	done

	${ewarn} "\${${1}} is not set and none of the default applications were found!" >&2
}

: ${UNKNOWN:=$(firstworking wine mono ilrun dosbox dosemu UNKNOWN)}
: ${MSDOS:=$(firstworking dosbox dosemu MSDOS)}
: ${WIN32:=$(firstworking wine WIN32)}
: ${CLR:=$(firstworking mono ilrun CLR)}
: ${WIN64:=$(firstworking wine64 WIN64)}

if [ -z "${UNKNOWN}" -a -z "${MSDOS}" -a -z "${WIN32}" -a -z "${CLR}" -a -z "${WIN64}" ]; then
	${eerror} 'None of the expected interpreters were set, aborting.' >&2
	exit 1
else
	printf '%s\0' "${UNKNOWN}" "${MSDOS}" "${WIN32}" "${CLR}" "${WIN64}" > @pkgstatefile@
	exit ${?}
fi
